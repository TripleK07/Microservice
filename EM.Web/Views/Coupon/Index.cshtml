@{
    ViewData["Title"] = "Index";
}

<div>
    <div>
        <h3>Coupons List</h3>
        <button style="float:right;" class="btn btn-primary" onclick="addCoupon()"><i class="bi bi-plus-circle"></i> Add
            Coupon</button>
    </div>
    <div id="coupon-table">
        @* bind partial here *@
    </div>
</div>

<!-- Vertically centered scrollable modal -->
<div class="modal fade" id="modal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Add Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body">
                @* bind partial here *@
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_ENDPOINTS = {
            GET_ALL: '/Coupon/GetAllCoupons',
            CREATE: '/Coupon/Create',
            EDIT: '/Coupon/Edit',
            DELETE: '/Coupon/Delete'
        };

        function showErrorMessage(error) {
            Swal.fire({
                title: "Error",
                text: error.message || "An error occurred",
                icon: "error",
                draggable: true
            });
        }

        function showSuccessMessage(response) {
            Swal.fire({
                title: "Coupon",
                text: response.message,
                icon: response.isSuccess ? "success" : "error",
                draggable: true
            });
        }

        function handleFormSubmit(url, formData) {
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.isSuccess) {
                        $("#modal").modal('hide');
                    }
                    showSuccessMessage(response);
                    loadCoupons();
                },
                error: (xhr, status, error) => showErrorMessage(error)
            });
        }

        function loadCoupons() {
            $.get(API_ENDPOINTS.GET_ALL)
                .done(response => $("#coupon-table").html(response))
                .fail((xhr, status, error) => showErrorMessage(error));
        }

        function addCoupon() {
            $.get(API_ENDPOINTS.CREATE)
                .done(response => {
                    $("#modal-body").html(response);
                    $("#modal").modal('show');

                    $("#create-coupon-form").on('submit', function (e) {
                        e.preventDefault();
                        handleFormSubmit(API_ENDPOINTS.CREATE, $(this).serialize());
                    });
                })
                .fail((xhr, status, error) => showErrorMessage(error));
        }

        function editCoupon(id) {
            $.get(API_ENDPOINTS.EDIT, { id: id })
                .done(response => {
                    $("#modal-body").html(response);
                    $("#modal").modal('show');

                    $("#create-coupon-form").on('submit', function (e) {
                        e.preventDefault();
                        handleFormSubmit(API_ENDPOINTS.EDIT, $(this).serialize());
                    });
                })
                .fail((xhr, status, error) => showErrorMessage(error));
        }

        function deleteCoupon(id) {
            Swal.fire({
                title: "Delete Coupon?",
                text: "Are you sure to delete this coupon?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post(API_ENDPOINTS.DELETE, { id: id })
                        .done(response => {
                            showSuccessMessage(response);
                            loadCoupons();
                        })
                        .fail((xhr, status, error) => showErrorMessage(error));
                }
            });
        }

        $(document).ready(loadCoupons);
    </script>
}